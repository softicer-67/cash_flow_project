{% extends 'cash_flow_app/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center fade-in">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row g-3">
                        <!-- Дата создания -->
                        <div class="col-md-6 required">
                            <label for="{{ form.created_date.id_for_label }}" class="form-label">
                                {{ form.created_date.label }}
                            </label>
                            {{ form.created_date }}
                            {% if form.created_date.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.created_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Статус -->
                        <div class="col-md-6 required">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.status.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Тип операции -->
                        <div class="col-md-6 required">
                            <label for="{{ form.operation_type.id_for_label }}" class="form-label">
                                {{ form.operation_type.label }}
                            </label>
                            {{ form.operation_type }}
                            {% if form.operation_type.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.operation_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Сумма -->
                        <div class="col-md-6 required">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">
                                {{ form.amount.label }}
                            </label>
                            <div class="input-group">
                                {{ form.amount }}
                                <span class="input-group-text">руб.</span>
                            </div>
                            {% if form.amount.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.amount.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Категория -->
                        <div class="col-md-6 required">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {{ form.category.label }}
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.category.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Выберите тип операции, чтобы загрузить категории</div>
                        </div>

                        <!-- Подкатегория -->
                        <div class="col-md-6 required">
                            <label for="{{ form.subcategory.id_for_label }}" class="form-label">
                                {{ form.subcategory.label }}
                            </label>
                            {{ form.subcategory }}
                            {% if form.subcategory.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.subcategory.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Выберите категорию, чтобы загрузить подкатегории</div>
                        </div>

                        <!-- Комментарий -->
                        <div class="col-12">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.comment.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Необязательное поле</div>
                        </div>
                    </div>

                    <!-- Кнопки -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Сохранить
                            </button>
                            <a href="{% url 'cash_flow_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Отмена
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Подсказка по обязательным полям -->
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> Поля, отмеченные <span class="text-danger">*</span>, обязательны для заполнения
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Загрузка категорий при изменении типа операции
    $('#id_operation_type').change(function() {
        var operationTypeId = $(this).val();
        var categoryField = $('#id_category');
        var subcategoryField = $('#id_subcategory');

        if (operationTypeId) {
            $.ajax({
                url: '{% url "load_categories" %}',
                data: {
                    'operation_type_id': operationTypeId
                },
                success: function(data) {
                    categoryField.empty();
                    categoryField.append('<option value="">---------</option>');
                    $.each(data, function(index, category) {
                        categoryField.append('<option value="' + category.id + '">' + category.name + '</option>');
                    });

                    // Очищаем подкатегории
                    subcategoryField.empty();
                    subcategoryField.append('<option value="">---------</option>');
                },
                error: function() {
                    console.error('Ошибка загрузки категорий');
                    categoryField.empty();
                    categoryField.append('<option value="">---------</option>');
                    subcategoryField.empty();
                    subcategoryField.append('<option value="">---------</option>');
                }
            });
        } else {
            categoryField.empty();
            categoryField.append('<option value="">---------</option>');
            subcategoryField.empty();
            subcategoryField.append('<option value="">---------</option>');
        }
    });

    // Загрузка подкатегорий при изменении категории
    $('#id_category').change(function() {
        var categoryId = $(this).val();
        var subcategoryField = $('#id_subcategory');

        if (categoryId) {
            $.ajax({
                url: '{% url "load_subcategories" %}',
                data: {
                    'category_id': categoryId
                },
                success: function(data) {
                    subcategoryField.empty();
                    subcategoryField.append('<option value="">---------</option>');
                    $.each(data, function(index, subcategory) {
                        subcategoryField.append('<option value="' + subcategory.id + '">' + subcategory.name + '</option>');
                    });
                },
                error: function() {
                    console.error('Ошибка загрузки подкатегорий');
                    subcategoryField.empty();
                    subcategoryField.append('<option value="">---------</option>');
                }
            });
        } else {
            subcategoryField.empty();
            subcategoryField.append('<option value="">---------</option>');
        }
    });

    // Инициализация при загрузке страницы
    // Если тип операции уже выбран, загружаем категории
    var initialOperationType = $('#id_operation_type').val();
    if (initialOperationType) {
        $('#id_operation_type').trigger('change');
    }

    // Если категория уже выбрана, загружаем подкатегории
    var initialCategory = $('#id_category').val();
    if (initialCategory) {
        $('#id_category').trigger('change');
    }

    // Валидация формы перед отправкой
    $('form').submit(function(e) {
        var isValid = true;
        var errorFields = [];

        // Проверка обязательных полей
        $('.required select, .required input').each(function() {
            if (!$(this).val()) {
                isValid = false;
                errorFields.push($(this).attr('name'));
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // Проверка суммы (должна быть положительной)
        var amount = $('#id_amount').val();
        if (amount && parseFloat(amount) <= 0) {
            isValid = false;
            $('#id_amount').addClass('is-invalid');
            errorFields.push('amount');
        }

        if (!isValid) {
            e.preventDefault();
            alert('Пожалуйста, заполните все обязательные поля корректно.');
        }
    });

    // Убираем класс ошибки при изменении поля
    $('select, input, textarea').change(function() {
        if ($(this).val()) {
            $(this).removeClass('is-invalid');
        }
    });
});
</script>

<style>
.required label:after {
    content: " *";
    color: #dc3545;
}

.is-invalid {
    border-color: #dc3545 !important;
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}

.card {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.input-group-text {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
}
</style>
{% endblock %}


